<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>üì¶ Malzemeler</title>
  <style>
    body { font-family: Arial; background:#f4f6f9; padding:20px; }
    h1 { margin-bottom: 20px; }
    .material { padding:10px; background:white; margin-bottom:8px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); cursor:context-menu; }
    .critical { color:red; }
    #context-menu { position:absolute; display:none; background:white; border:1px solid #ccc; list-style:none; padding:5px; border-radius:5px; }
    #context-menu li { padding:8px 12px; cursor:pointer; }
    #context-menu li:hover { background:#eee; }
    #overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    #modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:8px; width:300px; }
    #modal input { width:100%; margin:6px 0; padding:6px; }
  </style>
</head>
<body>
  <h1>üì¶ Malzeme Listesi</h1>
  <div id="materialList"></div>

  <!-- Context Menu -->
  <ul id="context-menu">
    <li id="ctx-add">‚ûï Ekle</li>
    <li id="ctx-edit">‚úèÔ∏è D√ºzenle</li>
    <li id="ctx-delete">üóëÔ∏è Sil</li>
  </ul>

  <!-- Modal -->
  <div id="overlay"></div>
  <div id="modal">
    <h3 id="modal-title">Yeni Malzeme</h3>
    <input id="mat-name" placeholder="Ad">
    <input id="mat-code" placeholder="Kod">
    <input id="mat-unit" placeholder="Birim">
    <input id="mat-qty" type="number" placeholder="Miktar">
    <input id="mat-min" type="number" placeholder="Min Stok">
    <button id="saveBtn">Kaydet</button>
    <button onclick="closeModal()">Kapat</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AI...SkBWS0",
      authDomain: "poleroyuncak.firebaseapp.com",
      projectId: "poleroyuncak",
      storageBucket: "poleroyuncak.firebasestorage.app",
      messagingSenderId: "473844630811",
      appId: "1:473844630811:web:bd89bb7d85c7b17ea03fbe"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const list = document.getElementById("materialList");
    const contextMenu = document.getElementById("context-menu");
    const overlay = document.getElementById("overlay");
    const modal = document.getElementById("modal");
    let currentId = null;

    function openModal(edit=false,data={}) {
      overlay.style.display="block"; modal.style.display="block";
      document.getElementById("modal-title").textContent= edit?"Malzeme D√ºzenle":"Yeni Malzeme";
      document.getElementById("mat-name").value=data.name||"";
      document.getElementById("mat-code").value=data.code||"";
      document.getElementById("mat-unit").value=data.unit||"";
      document.getElementById("mat-qty").value=data.total_qty||"";
      document.getElementById("mat-min").value=data.min_qty||"";
      currentId = edit? data.id:null;
    }
    function closeModal(){ overlay.style.display="none"; modal.style.display="none"; }

    async function loadMaterials(){
      list.innerHTML="‚è≥ Y√ºkleniyor...";
      const snap=await getDocs(collection(db,"materials"));
      list.innerHTML="";
      snap.forEach(d=>{
        const m=d.data(); 
        const div=document.createElement("div");
        div.className="material";
        if(m.total_qty < m.min_qty) div.classList.add("critical");
        div.dataset.id=d.id;
        div.textContent=`${m.name} (${m.code}) ‚Äì ${m.total_qty} ${m.unit} (Min:${m.min_qty})`;
        list.appendChild(div);
      });
    }

    document.addEventListener("contextmenu",(e)=>{
      const card=e.target.closest(".material");
      if(card){ currentId=card.dataset.id;
        contextMenu.style.display="block"; 
        contextMenu.style.top=`${e.pageY}px`; contextMenu.style.left=`${e.pageX}px`;
        e.preventDefault();
      }
    });
    document.addEventListener("click",()=>contextMenu.style.display="none");

    document.getElementById("ctx-add").onclick=()=>openModal();
    document.getElementById("ctx-edit").onclick=async ()=>{
      if(!currentId) return;
      const snap=await getDocs(collection(db,"materials"));
      snap.forEach(d=>{ if(d.id===currentId) openModal(true,{id:d.id,...d.data()}); });
    };
    document.getElementById("ctx-delete").onclick=async ()=>{
      if(currentId && confirm("Silinsin mi?")){ await deleteDoc(doc(db,"materials",currentId)); loadMaterials(); }
    };
    document.getElementById("saveBtn").onclick=async ()=>{
      const name=document.getElementById("mat-name").value;
      const code=document.getElementById("mat-code").value;
      const unit=document.getElementById("mat-unit").value;
      const qty=Number(document.getElementById("mat-qty").value);
      const min_qty=Number(document.getElementById("mat-min").value);
      if(currentId){ await updateDoc(doc(db,"materials",currentId),{name,code,unit,total_qty:qty,min_qty}); }
      else{ await addDoc(collection(db,"materials"),{name,code,unit,total_qty:qty,min_qty}); }
      closeModal(); loadMaterials();
    };

    loadMaterials();
  </script>
</body>
</html>
